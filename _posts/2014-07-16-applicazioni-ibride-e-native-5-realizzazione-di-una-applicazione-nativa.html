---
layout: post
title: 'Applicazioni Ibride e Native #5 – Realizzazione di una Applicazione Nativa'
date: 2014-07-16 22:46:39.000000000 +02:00
categories:
- Applicazioni Ibride e Native
- Programmazione
tags:
- android
- applicazioni native
- java
status: publish
type: post
published: true
---
<h2>Content Provider</h2>
<p class="western">In Android i <i>Content Provider</i> sono utilizzati per disaccoppiare il layer di persistenza dal layer applicativo. Ogni applicazione ha accesso ad un database privato, usando i C<i>ontent Provider</i> è possibile invece condividere i dati con altre applicazioni, ed è inoltre possibile eseguire query asincrone su di essi per ottenere un'applicazione <i>responsive</i>. Android ha diversi <i>Content Provider built-in </i>utilizzabili dagli sviluppatori, ad esempio <i>Media Store</i>, <i>Contacts</i>, <i>Calendar</i> e <i>Call Log</i>. <span style="font-family: Helvetica, sans-serif;">È</span><span style="font-family: Helvetica, sans-serif;"> inoltre possibile definire nuovi content provider.</span></p>
<p class="western">
<p><!--more--></p>
<h3 class="western"><a href="https://github.com/dcampogiani/My-Native-Photo-Diary/blob/master/MyNativePhotoDiary/src/main/java/com/danielecampogiani/mynativephotodiary/persistence/PicturesProvider.java">PicturesProvider</a></h3>
<p class="western"><span style="font-family: Helvetica, sans-serif;">Per l'applicazione ho realizzato un provider per memorizzare e ottenere i dati relativi alle foto scattate dall'utente. Il provider al suo interno utilizza un database </span><span style="font-family: Helvetica, sans-serif;"><i>SQLite</i></span><span style="font-family: Helvetica, sans-serif;"> gestito estendendo la classe di </span><span style="font-family: Helvetica, sans-serif;"><i>SQLiteOpenHelper</i></span><span style="font-family: Helvetica, sans-serif;"> fornita da Android.</span></p>
<p class="western"><span style="font-family: Helvetica, sans-serif;">Il database ha una singola tabella che memorizza il path su filesystem dell'immagine, la descrizione inserita dall'utente, le coordinate geografiche ed un id univoco.</span></p>
<p class="western"><span style="font-family: Helvetica, sans-serif;">È</span><span style="font-family: Helvetica, sans-serif;"> possibile interrogare il provider per ottenere tutte le immagini attualmente memorizzate attraverso l'url </span><span style="font-family: Helvetica, sans-serif;"><i>content://com.danielecampogiani.picturesprovider/pictures</i></span><span style="font-family: Helvetica, sans-serif;">, mentre se si desidera ottenere informazioni su una specifica foto è sufficiente inserire in fondo all'url 'id della foto : </span><span style="font-family: Helvetica, sans-serif;"><i>content://com.danielecampogiani.picturesprovider/pictures/id</i></span><span style="font-family: Helvetica, sans-serif;">.</span></p>
<p class="western"><span style="font-family: Helvetica, sans-serif;">Dopo aver fatto un match sull'url richiesto al provider (per discriminare se sono richieste tutte le immagini, o una specifica) il content provider delega il reperimento dei dati al database, e nel caso di modifiche notifica i </span><span style="font-family: Helvetica, sans-serif;"><i>Content Resolver </i></span><span style="font-family: Helvetica, sans-serif;">permettendo così di ottenere delle callback lato applicativo senza dover rieseguire query (come spiegato più avanti).</span></p>
<h2 class="western">Activity</h2>
<p class="western">Una <i>Activity</i> rappresenta una schermata mostrata ad un utente solitamente occupando tutto lo schermo del dispositivo, per creare un'attività è sufficiente estendere la classe <i>Activity</i> e definire i metodi di callback richiamati dal sistema Android per gestire il ciclo di vita dell'attività.</p>
<h3 class="western"><a href="https://github.com/dcampogiani/My-Native-Photo-Diary/blob/master/MyNativePhotoDiary/src/main/java/com/danielecampogiani/mynativephotodiary/activities/MainActivity.java">MainActivity</a></h3>
<p class="western">Per l'applicazione ho creato una sola <i>Activity</i>, poiché utilizzo all'intero di essa diversi <i>Fragment</i> che vengono automaticamente mostrati/nascosti utilizzando un' <i>actionBar</i> a <i>tabs</i>.</p>
<p class="western">Per gestire le transazioni di <i>Fragment</i> ho creato la classe <i>TabListener</i> che si occupa di instanziare quando necessario il <i>fragment</i> che gestisce e di aggiungerlo e rimuoverlo dallo schermo utilizzando <i>FragmentTransaction</i> quando l'utente seleziona il tab relativo.</p>
<p class="western">Ho inoltre aggiunto un menu alla actionBar con un pulsante che quando selezionato crea <i>l'intent</i> <i>Mediastore.Action_Image_Capture</i> specificando un uri negli <i>extra</i> dell'<i>intent</i> poi <i>“lancia”</i> questo intent aspettando la restituzione del controllo con il metodo <i>startActivityForResult</i>. Così facendo verrà lanciata l'applicazione scelta dall'utente per scattare fotografie, e una volta che la foto è stata fatta sarà memorizzata nell'uri specificato negli extra dell'<i>intent </i> e il controllo tornerà all'attività <i>MainActivity</i>.</p>
<p class="western">Ogni qual volta possibile ho eseguito le operazioni all'interno di <i>AsyncTask</i>, questo permette di eseguire codice in background, senza quindi utilizzare il thread dedicato alla UI, e sincronizzare l'interfaccia grafica al termine della loro esecuzione.</p>
<p class="western">La classe <i>AsyncTask</i> si occupa della creazione, gestione e sincronizzazione di thread, per cui lo sviluppatore si deve preoccupare solamente di scrivere la logica applicativa.</p>
<p class="western">Nello specifico ho utilizzato <i>SavePictureAsyncTask</i> per leggere le coordinate geografiche dall'immagine restituita dall'applicazione fotocamera e per memorizzare l'immagine nel content provider, e <i>NewPictureAsyncTask</i> per le operazioni di I/O necessarie per creare il nuovo file sul filesystem.</p>
<h2 class="western">Fragments</h2>
<p class="western">I <i>fragment</i> vengono utilizzati per creare UI dinamiche e flessibili che si adattano a diversi schermi. Ogni <i>fragment</i> è un componente a se stante (con un suo ciclo di vita) utilizzabile da diverse activity. Per creare un nuovo <i>fragment</i> è sufficiente estendere la classe <i>Fragment</i>.</p>
<h3 class="western"><a href="https://github.com/dcampogiani/My-Native-Photo-Diary/blob/master/MyNativePhotoDiary/src/main/java/com/danielecampogiani/mynativephotodiary/fragments/TimelineFragment.java">TimelineFragment</a></h3>
<p class="western"><span style="font-family: Helvetica, sans-serif;">È</span><span style="font-family: Helvetica, sans-serif;"> il fragment collegato al tab </span><span style="font-family: Helvetica, sans-serif;"><i>“Timeline”</i></span><span style="font-family: Helvetica, sans-serif;"> e mostra in una lista (estende la classe </span><span style="font-family: Helvetica, sans-serif;"><i>ListFragment)</i></span><span style="font-family: Helvetica, sans-serif;"> le foto scattate in ordine cronologico. Sotto ogni foto è presente la descrizione e due pulsanti, uno per cancellare la foto e uno per condivide</span><span style="font-family: Helvetica, sans-serif;">rla.</span></p>
<p class="western"><span style="font-family: Helvetica, sans-serif;">Per ottenere le foto da mostrare utilizz</span><span style="font-family: Helvetica, sans-serif;">o</span><span style="font-family: Helvetica, sans-serif;"> un </span><span style="font-family: Helvetica, sans-serif;"><i>loader</i></span><span style="font-family: Helvetica, sans-serif;"> di </span><span style="font-family: Helvetica, sans-serif;"><i>cursor</i></span><span style="font-family: Helvetica, sans-serif;"> poiché le operazioni su database possono essere </span><span style="font-family: Helvetica, sans-serif;"><i>time-consuming</i></span><span style="font-family: Helvetica, sans-serif;">.</span></p>
<p class="western"><span style="font-family: Helvetica, sans-serif;">I </span><span style="font-family: Helvetica, sans-serif;"><i>loaders</i></span><span style="font-family: Helvetica, sans-serif;"> sono un meccanismo per caricare dati in maniera asincrona e per monitorare le sorgenti di dati. Possono essere utilizzati per qualunque tipo di dato, nell'applicazione li ho utilizzati per caricare dei </span><span style="font-family: Helvetica, sans-serif;"><i>cursor</i></span><span style="font-family: Helvetica, sans-serif;"> ossia il risultato di query su database in Android.</span></p>
<p class="western"><span style="font-family: Helvetica, sans-serif;">Per ottenere un comportamento asincrono all'interno del fragment ho implementato l'interfaccia </span><span style="font-family: Helvetica, sans-serif;"><i>LoaderManager.LoaderCallbacks&lt;Cursor&gt;</i></span><span style="font-family: Helvetica, sans-serif;"> realizzando i metodi:</span></p>
<ul>
<li>
<p class="western"><span style="font-family: Helvetica, sans-serif;">onCreateLoader: responsabile di creare il loader (usando la classe </span><span style="font-family: Helvetica, sans-serif;"><i>CursorLoader</i></span><span style="font-family: Helvetica, sans-serif;"> di Android) specificando i parametri della query desiderata.</span></p>
</li>
<li>
<p class="western"><span style="font-family: Helvetica, sans-serif;">onLoadFinished: richiamato quando la query asincrona restituisce dei risultati che vengono passati come parametro in questo metodo. Il metodo è invocato anche ogni qual volta cambiano i dati di interesse per la query specificata nel metodo onCreateLoader.</span></p>
</li>
<li>
<p class="western"><span style="font-family: Helvetica, sans-serif;">onLoaderReset: </span><span style="font-family: Helvetica, sans-serif;">per resettare il loader.</span></p>
</li>
</ul>
<p class="western"><span style="font-family: Helvetica, sans-serif;">P</span><span style="font-family: Helvetica, sans-serif;">er lo specifico fragment, il loader creato interroga il </span><span style="font-family: Helvetica, sans-serif;"><i>PicturesProvider</i></span><span style="font-family: Helvetica, sans-serif;"> richiedendo l'id, la descrizione e il path su filesystem di ogni foto.</span></p>
<p class="western"><span style="font-family: Helvetica, sans-serif;">Nel metodo </span><span style="font-family: Helvetica, sans-serif;"><i>onLoadFinished</i></span><span style="font-family: Helvetica, sans-serif;"> aggiorno la grafica mostrando i risultati utilizzando come </span><span style="font-family: Helvetica, sans-serif;"><i>adapter</i></span><span style="font-family: Helvetica, sans-serif;"> della lista la classe </span><span style="font-family: Helvetica, sans-serif;"><i>TimelinePicturesAdapter</i></span>.</p>
<h3 class="western"><a href="https://github.com/dcampogiani/My-Native-Photo-Diary/blob/master/MyNativePhotoDiary/src/main/java/com/danielecampogiani/mynativephotodiary/fragments/PlacesFragment.java">PlacesFragment</a></h3>
<p class="western">Il fragment collegato al tab <i>“Places”</i> mostra sullo schermo una google map centrata sulla posizione attuale dell'utente e ogni foto nelle coordinate geografiche nelle quali è stata scattata.</p>
<p class="western">Anche in questo <i>fragment</i> ottengo dati in maniera asincrona implementando l'interfaccia <span style="font-family: Helvetica, sans-serif;"><i>LoaderManager.LoaderCallbacks&lt;Cursor&gt;</i></span><span style="font-family: Helvetica, sans-serif;">richiedendo a </span><span style="font-family: Helvetica, sans-serif;"><i>PicturesProvider</i></span><span style="font-family: Helvetica, sans-serif;"> la latitudine, la longitudine e il path su filesystem per ogni foto.</span></p>
<p class="western"><span style="font-family: Helvetica, sans-serif;">Una volta ottenuti i dati provvedo ad aggiornare l'interfaccia grafica utilizzando l'</span><span style="font-family: Helvetica, sans-serif;"><i>AsyncTask</i></span><span style="font-family: Helvetica, sans-serif;"><i>AddMarkersAsyncTask</i></span><span style="font-family: Helvetica, sans-serif;"> che elabora le foto restituite dal loader creando dei </span><span style="font-family: Helvetica, sans-serif;"><i>marker</i></span><span style="font-family: Helvetica, sans-serif;"> da mostrare sulla mappa.</span></p>
<p class="western"><span style="font-family: Helvetica, sans-serif;">Per ottenere la posizione attuale dell'utente utilizzo la classe </span><span style="font-family: Helvetica, sans-serif;"><i>LocationClient</i></span><span style="font-family: Helvetica, sans-serif;"> e implemento le interfacce di Android </span><span style="font-family: Helvetica, sans-serif;"><i>GooglePlayServicesClient.OnConnectionFailedListener e GooglePlayServicesClient.ConnectionCallbacks</i></span><span style="font-family: Helvetica, sans-serif;"> e aggiornando l'interfaccia nella callback che restituisce la posizione dell'utente.</span></p>
<h2 class="western">Adapter</h2>
<p class="western">Gli <i>adapter</i> sono usati per effettuare il binding tra i dati e le view che estendono <i>AdapterView</i>, come ad esempio <i>ListFragment</i> (che ho esteso per realizzare <i>TimelineFragment</i>). Gli adapter sono responsabili di creare le view figlie per mostrare i dati.</p>
<h3 class="western"><a href="https://github.com/dcampogiani/My-Native-Photo-Diary/blob/master/MyNativePhotoDiary/src/main/java/com/danielecampogiani/mynativephotodiary/adapters/TimelinePicturesAdapter.java">TimelinePicturesAdapter</a></h3>
<p class="western">Classe che estende <i>CursorAdapter</i> e per ogni cursor (una foto) utilizza una <i>ImageView</i> per visualizzare su schermo la foto, una <i>TextView</i> per mostrare la descrizione e due pulsanti, uno per condividere la foto e uno per cancellarla. Il pulsante per la cancellazione mostra inoltre un <i>AlertDialog</i> per chiedere conferma all'utente una volta selezionato. Il pulsante per la condivisione invece lancia l'<i>intent</i> <i>Intent.Action_Send</i> specificando come tipo di dato <i>image/jpeg</i>, così facendo l'utente può scegliere con quale applicazione condividere il file.</p>
<p class="western">Anche in questo caso ho utilizzato un <i>AsyncTask</i> per non svolgere operazioni potenzialmente lunghe nel thread della UI. <i>DeletePicturesAsyncTask</i> rimuove l'immagine dal content provider e dal filesystem.</p>
<h2 class="western">Layouts</h2>
<p class="western">I <i>Layouts</i> permettono di separare il layer di presentazione dalla logica di business, specificando l'interfaccia grafica in file XML invece che crearla via codice.</p>
<p class="western">Una volta definiti i file XML, questi possono essere <i>“inflated”</i> nei rispettivi componenti (<i>Activity</i> e <i>Fragment</i>) usando il metodo <i>setContentView</i> per le <i>Activity</i> e il metodo <i>Inflator.inflate </i>per i Fragment (l'oggetto <i>Inflator</i> è passato al <i>fragment</i> nel metodo <i>onCreateView</i>).</p>
<p class="western">L'utilizzo di <i>layouts</i> è considerato una <i>best practice</i> in Android, perché è un meccanismo che permette di creare interfacce ottimizzate per diversi tipi di hardware, ad esempio diverse dimensioni di schermo, o la presenza o meno di una tastiera o touchscreen.</p>
<p class="western">Per l'applicazione ho realizzato i seguenti layout:</p>
<ul>
<li>
<p class="western"><a href="https://github.com/dcampogiani/My-Native-Photo-Diary/blob/master/MyNativePhotoDiary/src/main/res/layout/activity_main.xml">activity_main.xml</a> : contiene un holder in cui collocare i fragment selezionati scegliendo un tab dell'actionBar.</p>
</li>
<li>
<p class="western"><a href="https://github.com/dcampogiani/My-Native-Photo-Diary/blob/master/MyNativePhotoDiary/src/main/res/layout/dialog_description_layout.xml">dialog_description_layout.xml</a> : utilizzato per creare un <i>AlertDialog</i> in cui richiedere all'utente una descrizione testuale della foto appena scattata.</p>
</li>
<li>
<p class="western"><a href="https://github.com/dcampogiani/My-Native-Photo-Diary/blob/master/MyNativePhotoDiary/src/main/res/layout/fragment_places.xml">fragment_places.xml</a> : usato dal <i>fragment</i> <i>PlacesFragment</i> contiene al suo interno un <i>MapFragment</i> per mostrare la google map sullo schermo.</p>
</li>
<li>
<p class="western"><a href="https://github.com/dcampogiani/My-Native-Photo-Diary/blob/master/MyNativePhotoDiary/src/main/res/layout/fragment_timeline.xml">fragment_timeline.xml </a>: usato dal <i>fragment</i> <i>TimelineFragment</i> contiene al suo interno una <i>ListView</i> per mostrare tutte le fotografie.</p>
</li>
<li>
<p class="western"><a href="https://github.com/dcampogiani/My-Native-Photo-Diary/blob/master/MyNativePhotoDiary/src/main/res/layout/timeline_picture_layout.xml">timeline_picture_layout</a> : usato da TimelinePicturesAdapter responsabile di mostrare ogni singola fotografia nella lista sopra descritta. Per ogni foto mostra l'immagine vera e propria, la descrizione e due pulsanti, uno per cancellare la foto e uno per condividerla.</p>
</li>
</ul>
